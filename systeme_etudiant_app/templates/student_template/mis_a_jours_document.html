{% extends 'student_template/base_template.html' %}
{% load static %}

{% block page_title %} Mettre à jour mes documents {% endblock %}

{% block main_content %}
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-file-upload"></i> 
                            Mise à jour des documents - Inscription #{{ inscription.id }}
                        </h3>
                        <div class="card-tools">
                            <a href="{% url 'dossier_detail' inscription.id %}" class="btn btn-secondary btn-sm">
                                <i class="fas fa-arrow-left"></i> Retour au dossier
                            </a>
                        </div>
                    </div>

                    <div class="card-body">
                        {% if messages %}
                        <div class="mb-3">
                            {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                                {{ message }}
                                <button type="button" class="close" data-dismiss="alert">&times;</button>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- Résumé de l'inscription -->
                        <div class="alert alert-info mb-4">
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-1">
                                        <strong>Filière :</strong> 
                                        <span class="badge badge-primary">{{ inscription.filiere.get_Nom_filiere_display }}</span>
                                    </p>
                                    <p class="mb-1">
                                        <strong>Niveau :</strong> 
                                        <span class="badge badge-success">{{ inscription.niveau.nom_niveau }}</span>
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-1">
                                        <strong>Statut :</strong>
                                        {% if inscription.statut == 'rejeté' %}
                                            <span class="badge badge-danger">Rejeté</span>
                                        {% else %}
                                            <span class="badge badge-warning">En attente</span>
                                        {% endif %}
                                    </p>
                                    {% if inscription.motif_rejet %}
                                    <p class="mb-0">
                                        <strong>Motif du rejet :</strong> 
                                        <span class="text-danger">{{ inscription.motif_rejet }}</span>
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Instructions -->
                        <div class="alert alert-warning mb-4">
                            <h5><i class="fas fa-info-circle"></i> Instructions :</h5>
                            <ul class="mb-0">
                                <li>Téléchargez uniquement les documents que vous souhaitez remplacer</li>
                                <li>Les documents existants seront conservés si aucun nouveau n'est sélectionné</li>
                                <li>Taille maximum par fichier : <strong>5MB</strong></li>
                                <li>Formats acceptés : PDF, JPG, PNG</li>
                                {% if inscription.statut == 'rejeté' %}
                                <li class="text-danger"><strong>Après mise à jour, votre dossier sera réexaminé</strong></li>
                                {% endif %}
                            </ul>
                        </div>

                        <!-- Formulaire de mise à jour -->
                        <form method="POST" enctype="multipart/form-data" id="updateDocumentsForm">
                            {% csrf_token %}
                            
                            <div class="row">
                                {% for doc in documents %}
                                <div class="col-md-6 mb-4">
                                    <div class="card h-100 {% if doc.present %}border-success{% else %}border-danger{% endif %}">
                                        <div class="card-header {% if doc.present %}bg-success text-white{% else %}bg-danger text-white{% endif %}">
                                            <h5 class="mb-0">
                                                <i class="fas {% if doc.present %}fa-check-circle{% else %}fa-exclamation-circle{% endif %}"></i>
                                                {{ doc.nom }}
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <!-- Document actuel -->
                                            <div class="mb-3">
                                                <strong>Document actuel :</strong>
                                                {% if doc.present %}
                                                    <div class="mt-2">
                                                        <a href="{{ doc.fichier.url }}" target="_blank" 
                                                           class="btn btn-outline-primary btn-sm">
                                                            <i class="fas fa-eye"></i> Voir le document
                                                        </a>
                                                        <small class="text-muted d-block mt-1">
                                                            Téléchargé le : {{ doc.fichier|date:"d/m/Y" }}
                                                        </small>
                                                    </div>
                                                {% else %}
                                                    <span class="text-danger">
                                                        <i class="fas fa-times-circle"></i> Document manquant
                                                    </span>
                                                {% endif %}
                                            </div>

                                            <!-- Upload nouveau document -->
                                            <div class="form-group">
                                                <label for="{{ doc.nom_champ }}">
                                                    <strong>Télécharger un nouveau document :</strong>
                                                </label>
                                                <div class="custom-file">
                                                    <input type="file" 
                                                           class="custom-file-input" 
                                                           id="{{ doc.nom_champ }}" 
                                                           name="{{ doc.nom_champ }}"
                                                           accept=".pdf,.jpg,.jpeg,.png">
                                                    <label class="custom-file-label" for="{{ doc.nom_champ }}">
                                                        Choisir un fichier...
                                                    </label>
                                                </div>
                                                <small class="text-muted">
                                                    Laissez vide pour conserver le document actuel
                                                </small>
                                            </div>

                                            <!-- Aperçu (si c'est une image) -->
                                            <div id="preview-{{ doc.nom_champ }}" class="mt-2 d-none">
                                                <img src="#" alt="Aperçu" class="img-thumbnail" style="max-height: 150px;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>

                            <!-- Boutons d'action -->
                            <div class="card-footer">
                                <div class="d-flex justify-content-between">
                                    <a href="{% url 'dossier_detail' inscription.id %}" class="btn btn-secondary">
                                        <i class="fas fa-times"></i> Annuler
                                    </a>
                                    <button type="submit" class="btn btn-success" id="submitBtn">
                                        <i class="fas fa-save"></i> Mettre à jour les documents
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block custom_js %}
<script>
$(document).ready(function() {
    // Gestion des noms de fichiers
    $('.custom-file-input').on('change', function() {
        const fileName = $(this).val().split('\\').pop();
        $(this).next('.custom-file-label').addClass("selected").html(fileName);
        
        // Aperçu pour les images
        if (this.files && this.files[0]) {
            const file = this.files[0];
            const previewId = '#preview-' + $(this).attr('name');
            const previewDiv = $(previewId);
            
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewDiv.find('img').attr('src', e.target.result);
                    previewDiv.removeClass('d-none');
                }
                reader.readAsDataURL(file);
            } else {
                previewDiv.addClass('d-none');
            }
        }
    });

    // Validation du formulaire
    $('#updateDocumentsForm').on('submit', function(e) {
        let hasNewFile = false;
        const sizeLimit = 5 * 1024 * 1024; // 5MB
        
        // Vérifier si au moins un fichier est sélectionné
        $(this).find('input[type="file"]').each(function() {
            if (this.files && this.files[0]) {
                hasNewFile = true;
                
                // Vérifier la taille
                if (this.files[0].size > sizeLimit) {
                    e.preventDefault();
                    alert(`Le fichier "${this.files[0].name}" est trop lourd (Max 5MB)`);
                    return false;
                }
                
                // Vérifier le type
                const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
                if (!allowedTypes.includes(this.files[0].type)) {
                    e.preventDefault();
                    alert(`Format non supporté pour "${this.files[0].name}"\nFormats acceptés: PDF, JPG, PNG`);
                    return false;
                }
            }
        });

        if (!hasNewFile) {
            e.preventDefault();
            alert("Veuillez sélectionner au moins un document à mettre à jour.");
            return false;
        }

        // Confirmation
        if (!confirm("Confirmez-vous la mise à jour de vos documents ?")) {
            e.preventDefault();
            return false;
        }

        // Désactiver le bouton pour éviter les doubles clics
        $('#submitBtn').prop('disabled', true)
                       .html('<i class="fas fa-spinner fa-spin"></i> Mise à jour en cours...');
        return true;
    });
});
</script>
{% endblock %}