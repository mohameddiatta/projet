{% extends 'student_template/base_template.html' %}

{% block page_title %}
Mon Profil
{% endblock page_title %}

{% block main_content %}
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-8">
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">Compléter mon profil</h3>
                    </div>

                    {% if messages %}
                    <div class="m-3">
                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <form method="POST" enctype="multipart/form-data">
                        {% csrf_token %}

                        <div class="card-body">
                            <h5 class="mb-4">Informations personnelles *</h5>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Prénom *</label>
                                        <input type="text"
                                               name="first_name"
                                               class="form-control"
                                               value="{{ initial_data.first_name }}"
                                               placeholder="Votre prénom"
                                               required>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Nom *</label>
                                        <input type="text"
                                               name="last_name"
                                               class="form-control"
                                               value="{{ initial_data.last_name }}"
                                               placeholder="Votre nom"
                                               required>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Email *</label>
                                        <input type="email"
                                               name="email"
                                               class="form-control"
                                               value="{{ initial_data.email }}"
                                               placeholder="votre@email.com"
                                               required>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Numéro INE *</label>
                                        <input type="text"
                                               name="numero_ine"
                                               class="form-control"
                                               value="{{ initial_data.numero_ine }}"
                                               placeholder="A0012847562"
                                               required>
                                        <small class="text-muted">1 lettre + (11 chiffres )</small>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Téléphone *</label>
                                        <input type="text"
                                               name="telephone"
                                               class="form-control"
                                               value="{{ initial_data.telephone }}"
                                               placeholder="+221 770000000"
                                               required>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Date de naissance *</label>
                                        <input type="date"
                                               name="date_naissance"
                                               class="form-control"
                                               value="{{ initial_data.date_naissance }}"
                                               required>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Genre *</label>
                                        <select name="gender" class="form-control" required>
                                            <option value="">-- Sélectionner --</option>
                                            <option value="Male" {% if initial_data.gender == 'Male' %}selected{% endif %}>Masculin</option>
                                            <option value="Female" {% if initial_data.gender == 'Female' %}selected{% endif %}>Féminin</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Adresse complète *</label>
                                <textarea name="adresse"
                                          class="form-control"
                                          rows="3"
                                          placeholder="Numéro, rue, code postal, ville"
                                          required>{{ initial_data.adresse }}</textarea>
                            </div>


                            <div class="form-group">
                                <label>Photo de profil</label>
                                <div class="custom-file">
                                    <input type="file"
                                           name="profile_pic"
                                           class="custom-file-input"
                                           id="profile_pic"
                                           accept="image/*">
                                    <label class="custom-file-label" for="profile_pic">
                                        Choisir une photo...
                                    </label>
                                </div>
                                <small class="text-muted">Format: JPG, PNG - Max: 2MB</small>

                                {% if student.profile_pic %}
                                <div class="mt-2">
                                    <img src="{{ student.profile_pic.url }}" alt="Photo actuelle" class="img-thumbnail" style="max-width: 100px;">
                                    <small class="text-muted ml-2">Photo actuelle</small>
                                </div>
                                {% endif %}
                            </div>

                            <div class="alert alert-info mt-4">
                                <i class="fas fa-info-circle"></i>
                                <strong>Important :</strong> Tous les champs marqués d'un * sont obligatoires
                                pour pouvoir vous inscrire à une formation.
                            </div>
                        </div>

                        <div class="card-footer">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Enregistrer mon profil
                            </button>
                            <a href="{% url 'student_home' %}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Annuler
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card card-info">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-user-circle"></i> Votre profil actuel</h3>
                    </div>
                    <div class="card-body text-center">
                        {% if student.profile_pic %}
                        <img src="{{ student.profile_pic.url }}" alt="Photo" class="img-circle img-fluid" style="max-width: 150px;">
                        {% else %}
                        <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center"
                             style="width: 150px; height: 150px;">
                            <i class="fas fa-user fa-4x text-secondary"></i>
                        </div>
                        {% endif %}

                        <h5 class="mt-3">
                            {{ user.first_name|default:"Prénom" }} {{ user.last_name|default:"Nom" }}
                        </h5>

                        <p class="text-muted">
                            <i class="fas fa-envelope"></i> {{ user.email|default:"Non renseigné" }}
                        </p>

                        <div class="text-left small mt-3">
                            <p><strong>Numéro INE :</strong><br>
                            {{ student_info.ine|default:"Non renseigné" }}</p>

                            <p><strong>Téléphone :</strong><br>
                            {{ student_info.telephone|default:"Non renseigné" }}</p>

                            <p><strong>Date naissance :</strong><br>
                            {{ student_info.date_naissance|default:"Non renseignée" }}</p>

                            <p><strong>Adresse :</strong><br>
                            {{ student_info.adresse|default:"Non renseignée"|truncatechars:50 }}</p>

                            <p><strong>Genre :</strong><br>
                            {% if student.gender == 'Male' %}Masculin{% elif student.gender == 'Female' %}Féminin{% else %}Non renseigné{% endif %}</p>
                        </div>

                        <div class="alert alert-warning mt-3">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Statut du profil :</strong>
                            {% if user.first_name and user.last_name and user.email and student_info.ine and student_info.telephone and student_info.adresse and student_info.date_naissance %}
                            <span class="text-success fw-bold">Complet</span>
                            <a href="{% url 'inscription' %}" class="btn btn-success btn-sm mt-2 d-block">
                                <i class="fas fa-user-plus"></i> S'inscrire maintenant
                            </a>
                            {% else %}
                            <span class="text-primary fw-bold">Incomplet</span>
                            <small class="d-block mt-1">Complétez tous les champs obligatoires</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

{% block custom_js %}
<script>
$(document).ready(function() {

    // Afficher le nom du fichier photo sélectionné
    $('.custom-file-input').on('change', function() {
        let fileName = $(this).val().split('\\').pop();
        $(this).next('.custom-file-label').addClass("selected").html(fileName);
    });

    // Formatage automatique du téléphone SENEGAL (+221)
    $('input[name="telephone"]').on('input', function() {
        let value = $(this).val().replace(/\D/g, '');

        // Préfixes valides Sénégal
        const prefixes = ['70','75','76','77','78'];

        if (value.length >= 2 && prefixes.includes(value.substring(0, 2))) {
            value = '+221 ' + value.substring(0, 2) + ' ' + value.substring(2);
        }

        // Mise en forme: +221 77 123 45 67
        if (value.length > 9) value = value.substring(0, 9) + ' ' + value.substring(9);
        if (value.length > 12) value = value.substring(0, 12) + ' ' + value.substring(12);

        $(this).val(value);
    });

    // Validation du numéro INE Sénégal
    $('input[name="numero_ine"]').on('blur', function() {
        const ine = $(this).val().toUpperCase();

        // Format : 1 lettre + 11 chiffres
        const regexINE = /^[A-Z][0-9]{11}$/;

        if (ine && !regexINE.test(ine)) {
            alert("Le numéro INE doit commencer par une lettre (ex: A) et être suivi de 11 chiffres.");
            $(this).focus();
        } else {
            $(this).val(ine); // Mettez en majuscule automatiquement
        }
    });

});
</script>

{% endblock custom_js %}
{% endblock main_content %}