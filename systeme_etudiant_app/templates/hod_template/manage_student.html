{% extends 'hod_template/base_template.html' %}
{% block page_title %}
Gestion des Étudiants
{% endblock page_title %}

{% block main_content %}
{% load static %}
<style>
    td a {
        display: inline-block;
        margin-right: 5px;
    }
    .student-photo {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 50%;
        border: 2px solid #dee2e6;
    }
    .avatar-initials {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(45deg, #11998e, #38ef7d);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 18px;
    }
    .search-btn {
        background: linear-gradient(45deg, #11998e, #38ef7d);
        border: none;
        color: white;
    }
</style>

<div class="app-content">
    <div class="container-fluid">
        <main id="main" class="main">
            <div class="pagetitle">
                <h1>Gestion des Étudiants</h1>
            </div>

            <section class="section">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="card card-primary card-outline mb-4">
                            <div class="card-body">
                                <!-- En-tête avec recherche -->
                                <div class="card-header mb-4 text-white" style="background: linear-gradient(45deg, #11998e, #38ef7d);">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">Liste des Étudiants</h5>
                                        <form method="GET" class="mb-0">
                                            <div class="input-group input-group-sm" style="width: 250px;">
                                                <input type="text" name="search" class="form-control"
                                                       placeholder="Rechercher..." value="{{ search_query|default:'' }}">
                                                <div class="input-group-append">
                                                    <button type="submit" class="btn btn-primary">
                                                        <i class="fas fa-search"></i>
                                                    </button>
                                                    {% if search_query %}
                                                    <a href="?" class="btn btn-light ml-1">
                                                        <i class="fas fa-times"></i>
                                                    </a>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>

                                <!-- Tableau CORRIGÉ -->
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" style="width:100%;">
                                        <thead class="text-white" style="background: linear-gradient(45deg, #11998e, #38ef7d);">
                                            <tr>
                                                <th>ID</th>
                                                <th>Photo</th>
                                                <th>First Name</th>
                                                <th>Last Name</th>
                                                <th>Username</th>
                                                <th>Email</th>
                                                <th>Address</th>
                                                <th>Gender</th>
                                                <th>Start Year</th>
                                                <th>End Year</th>
                                                <th>Course</th>
                                                <th>Last Login</th>
                                                <th>Date Joined</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for student in students %}
                                            <tr>
                                                <td>{{ student.admin.id }}</td>
                                                <td>
                                                    <!-- SOLUTION CORRECTE BASÉE SUR VOTRE DEBUG -->
                                                    {% if student.profile_pic and student.profile_pic.name %}
                                                        {% with pic_name=student.profile_pic.name %}
                                                            {% if pic_name|slice:":7" == "/media/" %}
                                                                <!-- CAS 1: Le name commence par "/media/" -->
                                                                <!-- Utiliser directement pic_name comme src -->
                                                                <img src="{{ pic_name }}"
                                                                     class="student-photo"
                                                                     alt="{{ student.admin.first_name }}"
                                                                     data-student-id="{{ student.admin.id }}"
                                                                     onerror="showInitials(this)">
                                                            {% else %}
                                                                <!-- CAS 2: Format normal -->
                                                                <img src="{{ student.profile_pic.url }}"
                                                                     class="student-photo"
                                                                     alt="{{ student.admin.first_name }}"
                                                                     data-student-id="{{ student.admin.id }}"
                                                                     onerror="showInitials(this)">
                                                            {% endif %}
                                                        {% endwith %}
                                                    {% else %}
                                                        <!-- Pas de photo -->
                                                        <div class="avatar-initials" id="initials-{{ student.admin.id }}">
                                                            {{ student.admin.first_name|first|upper }}
                                                        </div>
                                                    {% endif %}
                                                </td>
                                                <td>{{ student.admin.first_name }}</td>
                                                <td>{{ student.admin.last_name }}</td>
                                                <td>{{ student.admin.username }}</td>
                                                <td>{{ student.admin.email }}</td>
                                                <td>{{ student.address|truncatechars:20 }}</td>
                                                <td>
                                                    {% if student.gender == "Male" %}
                                                        <span class="badge bg-primary">M</span>
                                                    {% elif student.gender == "Female" %}
                                                        <span class="badge bg-danger">F</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ student.gender }}</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ student.session_year_id.session_start_year }}</td>
                                                <td>{{ student.session_year_id.session_end_year }}</td>
                                                <td>{{ student.course_id.course_name }}</td>
                                                <td>
                                                    {% if student.admin.last_login %}
                                                        {{ student.admin.last_login|date:"d/m/Y" }}
                                                    {% else %}
                                                        <span class="text-muted">Never</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ student.admin.date_joined|date:"d/m/Y H:i" }}</td>
                                                <td>
                                                    <a href="{% url 'edit_student' student_id=student.admin.id %}"
                                                       class="btn btn-success btn-sm">
                                                        Edit
                                                    </a>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="14" class="text-center py-4">
                                                    <div class="alert alert-info mb-0">
                                                        <i class="fas fa-user-graduate"></i>
                                                        Aucun étudiant trouvé.
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Pagination -->
                                {% if students.has_other_pages %}
                                <nav aria-label="Page navigation" class="mt-4">
                                    <ul class="pagination justify-content-center">
                                        {% if students.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link"
                                               href="?page={{ students.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">
                                                <i class="fas fa-chevron-left"></i>
                                            </a>
                                        </li>
                                        {% endif %}

                                        {% for i in students.paginator.page_range %}
                                            {% if students.number == i %}
                                            <li class="page-item active">
                                                <span class="page-link">{{ i }}</span>
                                            </li>
                                            {% elif i > students.number|add:'-3' and i < students.number|add:'3' %}
                                            <li class="page-item">
                                                <a class="page-link"
                                                   href="?page={{ i }}{% if search_query %}&search={{ search_query }}{% endif %}">
                                                    {{ i }}
                                                </a>
                                            </li>
                                            {% endif %}
                                        {% endfor %}

                                        {% if students.has_next %}
                                        <li class="page-item">
                                            <a class="page-link"
                                               href="?page={{ students.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">
                                                <i class="fas fa-chevron-right"></i>
                                            </a>
                                        </li>
                                        {% endif %}
                                    </ul>
                                </nav>
                                <div class="text-center text-muted">
                                    <small>Page {{ students.number }} sur {{ students.paginator.num_pages }}</small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
</div>

<script>
    // Fonction pour afficher les initiales quand une photo ne charge pas
    function showInitials(imgElement) {
        const studentId = imgElement.dataset.studentId;
        const altText = imgElement.alt || '';
        const firstName = altText || '';

        // Créer les initiales
        const initialsDiv = document.createElement('div');
        initialsDiv.className = 'avatar-initials';
        initialsDiv.id = 'initials-' + studentId;
        initialsDiv.innerHTML = firstName.charAt(0).toUpperCase();
        initialsDiv.title = altText;

        // Remplacer l'image
        imgElement.parentNode.replaceChild(initialsDiv, imgElement);

        console.log("Photo non chargée pour étudiant ID:", studentId, "URL:", imgElement.src);
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        // Vérifier les images après chargement
        setTimeout(function() {
            document.querySelectorAll('img.student-photo').forEach(img => {
                if (!img.complete || img.naturalHeight === 0) {
                    showInitials(img);
                }
            });
        }, 1000);
    });
</script>
{% endblock main_content %}