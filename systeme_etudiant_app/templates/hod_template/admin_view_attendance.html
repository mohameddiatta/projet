{% extends 'hod_template/base_template.html' %}

{% block page_title %}
 View Attendance
{% endblock page_title %}
{% block main_content %}
 <section class="content">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
     <div class="container-flui">
          <div class="row">
            <div class="col-md-12">
                <!--begin::Quick Example-->
                <div class="card card-primary card-outline mb-4">
                    <!--begin::Header-->
                     <div class="card-header text-white" style="background: linear-gradient(45deg, #11998e, #38ef7d);">
                        <div class="card-title">View Attendance</div>
                    </div>
                    <!--end::Header-->
                    <!--begin::Form-->

                        <!--begin::Body-->


                            <div class="form-group">
                               <label>Subject</label>
                               <select class="form-control" name="subject" id="subject">
                                 {% for subject in subjects %}
                                 <option value="{{ subject.id }}">{{ subject.subject_name }}</option>
                               {% endfor %}
                               </select>
                             </div>

                            <div class="form-group">
                               <label>Session Year</label>
                               <select class="form-control" name="session_year_id" id="session_year_id">
                                 {% for session_year in session_year_id %}
                                 <option value="{{ session_year.id }}">{{ session_year.session_start_year }} TO {{ session_year.session_end_year }}</option>
                               {% endfor %}
                               </select>
                             </div>

                            <div class="form-group mt-2">
                            <button type="button" class="btn btn-primary btn-block" id="fetch_attendance">Fetch Attendance Data</button>
                          </div>


                          <div class="form-group mt-2" id="attendance_block">
                               <label>Attendance Date</label>
                               <select class="form-control" name="attendance_date" id="attendance_date">

                               </select>
                          </div>
                             <div class="form-group mt-2">
                                 <div class="alert alert-danger" id="error_attendance" style="display:none;">

                                 </div>


                                <!-- BLOC QUI VA AFFICHER LES Ã‰TUDIANTS -->
                                  <div class="form-group mt-3" id="fetch_student_block" style="display:none;">
                               <button class="btn btn-info btn-block" id="fetch_student" type="button">
                                Fetch Student Data
                                       </button>
                                 </div>

                                <div class="form-group mt-3" id="student_data">
                               <!-- Les Ã©tudiants seront affichÃ©s ici -->
                               </div>
                                  </div>
                        <!--end::Footer-->

                </div>
                <!--end::Quick Example-->
            </div>
        </div>
        </div>


 </section>
{% endblock main_content %}
{% block custom_js %}
<script>
$(document).ready(function(){

    // --- 2. GESTIONNAIRE POUR RÃ‰CUPÃ‰RER LES DATES DE PRÃ‰SENCE ---
    $("#fetch_attendance").click(function(){
        var subject = $("#subject").val();
        var session_year = $("#session_year_id").val();

        $.ajax({
            url: '{% url "admin_get_attendance_dates" %}',
            type: 'POST',
            data: {subject: subject, session_year_id: session_year},
        })
        .done(function(json_data){      // ðŸ‘ˆ ICI : plus besoin de JSON.parse
            console.log(json_data);

            if(json_data.length > 0){
                var html_data = "";
                for(key in json_data){
                    html_data += "<option value=\"" + json_data[key]['id'] + "\">"
                               + json_data[key]["attendance_date"] + "</option>";
                }
                $("#error_attendance").hide();
                $("#attendance_block").show();
                $("#fetch_student_block").show();
                $("#attendance_date").html(html_data);
            } else {
                $("#error_attendance").html("No Attendance Data Found for this subject and session.");
                $("#error_attendance").show();
                $("#attendance_block").hide();
                $("#fetch_student_block").hide();
                $("#attendance_date").html("");
            }
        })
        .fail(function(){
            alert("Error in Fetching Attendance Dates.");
            $("#error_attendance").html("Communication Error with Server.");
            $("#error_attendance").show();
            $("#attendance_block").hide();
            $("#fetch_student_block").hide();
        });
    });

    // --- 3. GESTIONNAIRE POUR RÃ‰CUPÃ‰RER LES Ã‰TUDIANTS ---
    $("#fetch_student").click(function(){
        var attendance_date_id = $("#attendance_date").val();

        $.ajax({
            url: '{% url "admin_get_attendance_student" %}',
            type: 'POST',
            data: {attendance_date: attendance_date_id},
        })
        .done(function(json_data){   // ðŸ‘ˆ encore une fois : pas de JSON.parse
            console.log("DonnÃ©es Ã‰tudiant rÃ©cupÃ©rÃ©es :", json_data);

            if (json_data.error) {
                alert("Error in Fetching Student Data: " + json_data.error);
                $("#student_data").html("<p class='text-danger'>" + json_data.error + "</p>");
                return;
            }

            var div_data = "<div class='form-group'><label>Student Attendance :</label></div><div class='form-group'><div class='row'>";

            for (key in json_data) {
                var checked = json_data[key]['status'] == 1 ? "checked" : "";
                var status_text = json_data[key]['status'] == 1 ? "[PrÃ©sent]" : "[Absent]";

                div_data += `
                    <div class="col-lg-3">
                        <div class="form-check">
                            <input type="checkbox" name="student_data[]" class="form-check-input" value="${json_data[key]['id']}" ${checked}>
                            <label class="form-check-label">${json_data[key]['name']} ${status_text}</label>

                        </div>
                    </div>
                `;
            }


            $("#student_data").html(div_data);
        })
        .fail(function(xhr, status, error){
            alert("AJAX Error in Fetching Student Data: " + error);
        });
    });

});

</script>
{% endblock custom_js %}